# ğŸ—ï¸ Diagrama de Arquitetura: Leads & Kanban

## ğŸ“ VisÃ£o Geral da Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE (Browser)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   /admin/leads      â”‚         â”‚   /admin/kanban     â”‚          â”‚
â”‚  â”‚   (page.tsx)        â”‚         â”‚   (page.tsx)        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚             â”‚                               â”‚                      â”‚
â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚             â”‚               â”‚               â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  useLeads()     â”‚ â”‚ usePipelineâ”‚ â”‚ useLeadMetrics()â”‚         â”‚
â”‚  â”‚  (React Query)  â”‚ â”‚ Optimized()â”‚ â”‚ (React Query)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚               â”‚              â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚              â”‚
              â”‚  HTTP         â”‚  HTTP        â”‚  HTTP
              â”‚  GET/PUT      â”‚  GET         â”‚  GET
              â–¼               â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVIDOR (Next.js API)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ /api/leads     â”‚  â”‚ /api/        â”‚  â”‚ /api/analytics/  â”‚      â”‚
â”‚  â”‚                â”‚  â”‚ pipelines    â”‚  â”‚ metrics          â”‚      â”‚
â”‚  â”‚ GET, PUT       â”‚  â”‚              â”‚  â”‚                  â”‚      â”‚
â”‚  â”‚                â”‚  â”‚ GET          â”‚  â”‚ GET              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                  â”‚                    â”‚                â”‚
â”‚           â”‚  Supabase        â”‚  Retorna           â”‚  Calcula       â”‚
â”‚           â”‚  Client          â”‚  ENUM              â”‚  mÃ©tricas      â”‚
â”‚           â”‚                  â”‚  stages            â”‚                â”‚
â”‚           â–¼                  â–¼                    â–¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                  â”‚                    â”‚
              â”‚  SQL             â”‚  Hardcoded         â”‚  SQL
              â”‚  CRUD            â”‚  Array             â”‚  Aggregations
              â–¼                  â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BANCO DE DADOS (Supabase/PostgreSQL)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  ENUM lead_stage (7 valores fixos)                   â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚  1. lead_novo                                        â”‚         â”‚
â”‚  â”‚  2. qualificacao                                     â”‚         â”‚
â”‚  â”‚  3. apresentacao                                     â”‚         â”‚
â”‚  â”‚  4. visita_agendada                                  â”‚         â”‚
â”‚  â”‚  5. proposta                                         â”‚         â”‚
â”‚  â”‚  6. documentacao                                     â”‚         â”‚
â”‚  â”‚  7. fechamento                                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â–²                                      â”‚
â”‚                              â”‚ ReferÃªncia                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Tabela: leads            â”‚                          â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚  id: UUID (PK)            â”‚                          â”‚         â”‚
â”‚  â”‚  account_id: UUID         â”‚                          â”‚         â”‚
â”‚  â”‚  stage: lead_stage â”€â”€â”€â”€â”€â”€â”€â”˜ â† ENUM (nÃ£o FK)         â”‚         â”‚
â”‚  â”‚  name: VARCHAR                                       â”‚         â”‚
â”‚  â”‚  email: VARCHAR                                      â”‚         â”‚
â”‚  â”‚  phone: VARCHAR                                      â”‚         â”‚
â”‚  â”‚  assigned_to: UUID â†’ users.id                        â”‚         â”‚
â”‚  â”‚  score: INTEGER (0-100)                              â”‚         â”‚
â”‚  â”‚  temperature: VARCHAR                                â”‚         â”‚
â”‚  â”‚  created_at: TIMESTAMP                               â”‚         â”‚
â”‚  â”‚  updated_at: TIMESTAMP                               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Tabela: users                                       â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚  id: UUID (PK)                                       â”‚         â”‚
â”‚  â”‚  account_id: UUID                                    â”‚         â”‚
â”‚  â”‚  full_name: VARCHAR                                  â”‚         â”‚
â”‚  â”‚  email: VARCHAR                                      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de Drag-and-Drop (Kanban)

```
USUÃRIO                    FRONTEND                    API                  BANCO
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚  Arrasta Lead            â”‚                         â”‚                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                      â”‚
   â”‚                          â”‚ handleDragStart()       â”‚                      â”‚
   â”‚                          â”‚ setActiveId(leadId)     â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚  Solta em nova coluna    â”‚                         â”‚                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                      â”‚
   â”‚                          â”‚ handleDragEnd()         â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚                          â”‚ 1. Optimistic Update    â”‚                      â”‚
   â”‚                          â”‚    (UI muda AGORA)      â”‚                      â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                         â”‚                      â”‚
   â”‚  VÃª lead na nova coluna  â”‚                         â”‚                      â”‚
   â”‚  (instantÃ¢neo)           â”‚                         â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚                          â”‚ 2. API Call             â”‚                      â”‚
   â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ PUT /api/leads/:id   â”‚
   â”‚                          â”‚    {                    â”‚                      â”‚
   â”‚                          â”‚      stage: "proposta"  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                          â”‚    }                    â”‚  UPDATE leads        â”‚
   â”‚                          â”‚                         â”‚  SET stage='proposta'â”‚
   â”‚                          â”‚                         â”‚  WHERE id=...        â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚                          â”‚                         â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                         â”‚  { updated: true }   â”‚
   â”‚                          â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
   â”‚                          â”‚  Success!               â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚                          â”‚ 3. Confirm Update       â”‚                      â”‚
   â”‚                          â”‚    clearOptimistic()    â”‚                      â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                         â”‚                      â”‚
   â”‚  Toast: "Salvo!"         â”‚                         â”‚                      â”‚
   â”‚  VibraÃ§Ã£o (mobile)       â”‚                         â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
```

**Em caso de erro**:
```
   â”‚                          â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
   â”‚                          â”‚  Error 500              â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
   â”‚                          â”‚ 4. Rollback Update      â”‚                      â”‚
   â”‚                          â”‚    rollbackOptimistic() â”‚                      â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                         â”‚                      â”‚
   â”‚  VÃª lead VOLTAR          â”‚                         â”‚                      â”‚
   â”‚  Toast: "Erro! Revertido"â”‚                         â”‚                      â”‚
   â”‚                          â”‚                         â”‚                      â”‚
```

---

## ğŸ“Š Fluxo de CÃ¡lculo de MÃ©tricas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GET /api/analytics/metrics               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  SELECT * FROM leads        â”‚
           â”‚  WHERE account_id = ?       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  CÃ¡lculo no Servidor (Node.js)          â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                                         â”‚
           â”‚  totalLeads = leads.length              â”‚
           â”‚                                         â”‚
           â”‚  activeLeads = leads.filter(            â”‚
           â”‚    l => !l.archived                     â”‚
           â”‚  )                                      â”‚
           â”‚                                         â”‚
           â”‚  coldLeads = leads.filter(              â”‚
           â”‚    l => daysSinceContact > 30           â”‚
           â”‚  )                                      â”‚
           â”‚                                         â”‚
           â”‚  newLeadsWeek = leads.filter(           â”‚
           â”‚    l => created > weekAgo               â”‚
           â”‚  )                                      â”‚
           â”‚                                         â”‚
           â”‚  leadsByStage = leads.reduce(           â”‚
           â”‚    (acc, l) => {                        â”‚
           â”‚      acc[l.stage] = (acc[l.stage]||0)+1 â”‚
           â”‚      return acc                         â”‚
           â”‚    }, {}                                â”‚
           â”‚  )                                      â”‚
           â”‚                                         â”‚
           â”‚  conversionRate =                       â”‚
           â”‚    (convertedLeads / totalLeads) * 100  â”‚
           â”‚                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Return JSON                â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚  {                          â”‚
           â”‚    totalLeads: 156,         â”‚
           â”‚    activeLeads: 138,        â”‚
           â”‚    coldLeads: 18,           â”‚
           â”‚    newLeadsWeek: 23,        â”‚
           â”‚    leadsByStage: {...},     â”‚
           â”‚    conversionRate: 12.8     â”‚
           â”‚  }                          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Componente: PipelineKanbanBoard

```
PipelineKanbanBoard
â”œâ”€ Props
â”‚  â”œâ”€ pipeline: { id, name, stages[] }
â”‚  â”œâ”€ leads: Lead[]
â”‚  â”œâ”€ onLeadMove: (leadId, stageId) => Promise<void>
â”‚  â”œâ”€ onLeadClick: (lead) => void
â”‚  â””â”€ onRefresh: () => void
â”‚
â”œâ”€ State
â”‚  â”œâ”€ activeId: string | null (lead sendo arrastado)
â”‚  â”œâ”€ overStageId: string | null (coluna sob cursor)
â”‚  â”œâ”€ isCompactView: boolean (70px vs 180px)
â”‚  â”œâ”€ showMetrics: boolean (toggle mÃ©tricas)
â”‚  â””â”€ showFunnel: boolean (toggle funil)
â”‚
â”œâ”€ Hooks
â”‚  â”œâ”€ usePipelineMetrics(pipeline, leads)
â”‚  â”‚  â””â”€ Retorna: { totalLeads, stageMetrics, velocity, leadsByStage }
â”‚  â”‚
â”‚  â””â”€ useSensors() (PointerSensor para D&D)
â”‚
â”œâ”€ RenderizaÃ§Ã£o
â”‚  â”‚
â”‚  â”œâ”€ [Header]
â”‚  â”‚  â”œâ”€ TÃ­tulo: {pipeline.name}
â”‚  â”‚  â”œâ”€ Badge: {totalLeads} leads
â”‚  â”‚  â””â”€ Controles: Compacto/Funil/OpÃ§Ãµes
â”‚  â”‚
â”‚  â”œâ”€ [ConversionFunnel] (se showFunnel)
â”‚  â”‚  â””â”€ stageMetrics.map(stage => {
â”‚  â”‚       <Progress value={stage.percentage} />
â”‚  â”‚       <Badge>{stage.leadsCount} ({stage.percentage}%)</Badge>
â”‚  â”‚     })
â”‚  â”‚
â”‚  â”œâ”€ [DndContext]
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ [SortableContext]
â”‚  â”‚     â”‚
â”‚  â”‚     â””â”€ stages.map(stage => {
â”‚  â”‚          <VirtualizedStageColumn
â”‚  â”‚            stage={stage}
â”‚  â”‚            leads={leadsByStage[stage.id]}
â”‚  â”‚            isCompact={isCompactView}
â”‚  â”‚            showMetrics={showMetrics}
â”‚  â”‚          />
â”‚  â”‚        })
â”‚  â”‚
â”‚  â””â”€ [DragOverlay]
â”‚     â””â”€ {activeLead && (
â”‚          <OptimizedLeadCard
â”‚            lead={activeLead}
â”‚            isDragging={true}
â”‚            className="rotate-3 shadow-xl"
â”‚          />
â”‚        )}
â”‚
â””â”€ Handlers
   â”œâ”€ handleDragStart(event)
   â”œâ”€ handleDragOver(event)
   â””â”€ handleDragEnd(event)
```

---

## ğŸ“¦ Componente: VirtualizedStageColumn

```
VirtualizedStageColumn
â”œâ”€ Props
â”‚  â”œâ”€ stage: { id, name, color, order }
â”‚  â”œâ”€ leads: Lead[]
â”‚  â”œâ”€ onLeadClick: (lead) => void
â”‚  â”œâ”€ isCompact: boolean
â”‚  â””â”€ showMetrics: boolean
â”‚
â”œâ”€ State
â”‚  â”œâ”€ isCollapsed: boolean
â”‚  â””â”€ filterValue: string (busca local)
â”‚
â”œâ”€ Hooks
â”‚  â”œâ”€ useDroppable({ id: `stage-${stage.id}` })
â”‚  â”‚  â””â”€ Retorna: { setNodeRef, isOver }
â”‚  â”‚
â”‚  â””â”€ useStageMetrics(leads)
â”‚     â””â”€ Retorna: {
â”‚          totalLeads,
â”‚          avgTimeInStage,
â”‚          velocity,
â”‚          bottleneckRisk
â”‚        }
â”‚
â”œâ”€ RenderizaÃ§Ã£o
â”‚  â”‚
â”‚  â”œâ”€ [Card] (w-80)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ [StageHeader]
â”‚  â”‚  â”‚  â”œâ”€ Nome + cor (border-top: 3px)
â”‚  â”‚  â”‚  â”œâ”€ Badge: {totalLeads}
â”‚  â”‚  â”‚  â”œâ”€ Tempo mÃ©dio: {avgTimeInStage}d
â”‚  â”‚  â”‚  â”œâ”€ Badge de gargalo (se showMetrics)
â”‚  â”‚  â”‚  â””â”€ Input de busca
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ [CardContent] ref={setNodeRef} min-h-[300px]
â”‚  â”‚     â”‚
â”‚  â”‚     â””â”€ [SortableContext]
â”‚  â”‚        â”‚
â”‚  â”‚        â””â”€ {filteredLeads.length > 0 ? (
â”‚  â”‚             <List
â”‚  â”‚               height={listHeight}
â”‚  â”‚               itemCount={filteredLeads.length}
â”‚  â”‚               itemSize={isCompact ? 70 : 180}
â”‚  â”‚             >
â”‚  â”‚               {LeadItemRenderer}
â”‚  â”‚             </List>
â”‚  â”‚           ) : (
â”‚  â”‚             <EmptyState>
â”‚  â”‚               "Nenhum lead neste estÃ¡gio"
â”‚  â”‚             </EmptyState>
â”‚  â”‚           )}
â”‚  â”‚
â”‚  â””â”€ [Collapsed State]
â”‚     â””â”€ "Clique para expandir"
â”‚
â””â”€ Handlers
   â”œâ”€ handleToggleCollapse()
   â””â”€ handleFilterChange(value)
```

---

## ğŸ”— Fluxo de Dados Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UsuÃ¡rio abre  â”‚
â”‚  /admin/kanban â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Componente page.tsx renderiza   â”‚
â”‚     <PipelineKanbanBoard />         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Hooks disparam requests         â”‚
â”‚     â”œâ”€ usePipelineOptimized()       â”‚
â”‚     â”‚  â””â”€ GET /api/pipelines        â”‚
â”‚     â”‚     â””â”€ Retorna 7 estÃ¡gios     â”‚
â”‚     â”‚                                â”‚
â”‚     â””â”€ useLeads()                   â”‚
â”‚        â””â”€ GET /api/leads             â”‚
â”‚           â””â”€ Retorna leads da conta â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Frontend processa dados         â”‚
â”‚     â”œâ”€ usePipelineMetrics()         â”‚
â”‚     â”‚  â”œâ”€ Agrupa leads por stage    â”‚
â”‚     â”‚  â”œâ”€ Calcula percentuais       â”‚
â”‚     â”‚  â””â”€ Calcula velocidade        â”‚
â”‚     â”‚                                â”‚
â”‚     â””â”€ leadsByStage = {             â”‚
â”‚          lead_novo: [lead1, lead2], â”‚
â”‚          qualificacao: [lead3],     â”‚
â”‚          ...                         â”‚
â”‚        }                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Renderiza 7 colunas             â”‚
â”‚     â”œâ”€ Lead Novo (5 leads)          â”‚
â”‚     â”œâ”€ QualificaÃ§Ã£o (3 leads)       â”‚
â”‚     â”œâ”€ ApresentaÃ§Ã£o (1 lead)        â”‚
â”‚     â”œâ”€ Visita Agendada (2 leads)    â”‚
â”‚     â”œâ”€ Proposta (1 lead)            â”‚
â”‚     â”œâ”€ DocumentaÃ§Ã£o (1 lead)        â”‚
â”‚     â””â”€ Fechamento (2 leads)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. UsuÃ¡rio arrasta lead            â”‚
â”‚     â”œâ”€ Optimistic update (UI)       â”‚
â”‚     â”œâ”€ PUT /api/leads/:id           â”‚
â”‚     â”œâ”€ UPDATE leads SET stage=...   â”‚
â”‚     â””â”€ Toast de sucesso             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Sistema ENUM vs Tabela (ComparaÃ§Ã£o)

### âŒ Antigo (pipeline_stages)
```
SELECT
  l.*,
  ps.name as stage_name,
  ps.color as stage_color
FROM leads l
JOIN pipeline_stages ps ON l.pipeline_stage_id = ps.id
WHERE l.account_id = ?

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  leads  â”‚ â”€â”€â”€â”€â”€â–ºâ”‚ pipeline_stages  â”‚
â”‚         â”‚  FK   â”‚                  â”‚
â”‚ stage_idâ”œâ”€â”€â”€â”€â”€â”€â–ºâ”‚ id               â”‚
â”‚         â”‚       â”‚ name             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ color            â”‚
                  â”‚ pipeline_id      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problemas:
âŒ JOIN em toda query
âŒ InconsistÃªncia (stages podem ser deletados)
âŒ Complexidade (2 tabelas + relacionamento)
```

### âœ… Novo (ENUM)
```
SELECT
  l.*,
  l.stage  -- JÃ¡ vem com valor!
FROM leads l
WHERE l.account_id = ?

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  leads  â”‚       â”‚  ENUM lead_stage â”‚
â”‚         â”‚       â”‚                  â”‚
â”‚ stage â”€â”€â”¼â”€â”€â”€â”€â”€â”€â–ºâ”‚ lead_novo        â”‚
â”‚  (ENUM) â”‚       â”‚ qualificacao     â”‚
â”‚         â”‚       â”‚ apresentacao     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ visita_agendada  â”‚
                  â”‚ proposta         â”‚
                  â”‚ documentacao     â”‚
                  â”‚ fechamento       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Vantagens:
âœ… SEM JOINs
âœ… ConsistÃªncia garantida (ENUM nÃ£o muda)
âœ… Simplicidade (1 tabela)
âœ… Type-safety no PostgreSQL
âœ… Performance superior
```

---

**Ãšltima atualizaÃ§Ã£o**: 17 de Janeiro de 2025
**VersÃ£o da Arquitetura**: 3.0 (ENUM-based)
