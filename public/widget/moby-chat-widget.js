!function(){"use strict";class t{constructor(t){this.messageQueue=[],this.isOpen=!1,this.config=this.parseConfig(t);const e=t.src,i=new URL(e);this.baseUrl=`${i.protocol}//${i.host}`,this.init()}parseConfig(t){const e={};for(const i of t.attributes)if(i.name.startsWith("data-")){const t=i.name.substring(5).replace(/-([a-z])/g,((t,e)=>e.toUpperCase()));let s=i.value;if(s.startsWith("{")||s.startsWith("["))try{s=JSON.parse(s)}catch{}"true"===s?s=!0:"false"===s?s=!1:isNaN(Number(s))||(s=Number(s)),e[t]=s}return e}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>this.setup())):this.setup()}setup(){this.createContainer(),this.createBubble(),this.createIframe(),this.setupEventListeners(),this.trackEvent("widget_loaded"),this.config.autoOpen&&this.config.autoOpenDelay&&setTimeout((()=>this.open()),this.config.autoOpenDelay),window.MobyWidget={config:this.config,loaded:!0,iframe:this.iframe,bubble:this.bubble,open:()=>this.open(),close:()=>this.close(),toggle:()=>this.toggle(),sendMessage:t=>this.sendMessage(t)}}createContainer(){this.container=document.createElement("div"),this.container.id="moby-widget-container",this.container.style.cssText=`position:fixed;${"bottom-left"===this.config.position?"left":"right"}:${this.config.offsetSide||20}px;bottom:${this.config.offsetBottom||20}px;z-index:2147483647;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;`,document.body.appendChild(this.container)}createBubble(){this.bubble=document.createElement("div"),this.bubble.id="moby-widget-bubble",this.bubble.style.cssText=`width:60px;height:60px;border-radius:50%;background-color:${this.config.primaryColor||"#00A86B"};cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;`,this.bubble.innerHTML='<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 12H8.01M12 12H12.01M16 12H16.01M21 12C21 16.418 16.97 20 12 20C10.5 20 9.07 19.6 7.8 19L3 21L4.3 16.8C3.2 15.1 2.5 13.1 2.5 11C2.5 6.582 6.53 3 11.5 3C16.47 3 20.5 6.582 20.5 11C20.5 11.337 20.483 11.67 20.45 12H21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',this.bubble.addEventListener("mouseenter",(()=>{this.bubble.style.transform="scale(1.1)"})),this.bubble.addEventListener("mouseleave",(()=>{this.bubble.style.transform="scale(1)"})),this.container.appendChild(this.bubble)}createIframe(){const t=document.createElement("iframe");t.id="moby-widget-iframe",t.style.cssText=`position:absolute;${"bottom-left"===this.config.position?"left":"right"}:0;bottom:80px;width:380px;height:600px;max-height:calc(100vh - 100px);border:none;border-radius:16px;box-shadow:0 5px 40px rgba(0,0,0,0.16);opacity:0;transform:scale(0.95) translateY(20px);transform-origin:${"bottom-left"===this.config.position?"bottom left":"bottom right"};transition:all 0.3s ease;visibility:hidden;background-color:white;`;const e=new URLSearchParams({accountId:this.config.accountId||"",config:JSON.stringify(this.config)});t.src=`${this.baseUrl}/widget?${e.toString()}`,t.title="Moby Chat Widget",this.iframe=t,this.container.appendChild(t),this.addResponsiveStyles()}addResponsiveStyles(){const t=document.createElement("style");t.textContent=`@media(max-width:480px){#moby-widget-iframe{width:100vw!important;height:100vh!important;max-height:100vh!important;bottom:0!important;left:0!important;right:0!important;border-radius:0!important;}#moby-widget-bubble{bottom:20px!important;${"bottom-left"===this.config.position?"left":"right"}:20px!important;}}`,document.head.appendChild(t)}setupEventListeners(){this.bubble.addEventListener("click",(()=>this.toggle())),window.addEventListener("message",(t=>{if(t.origin!==this.baseUrl)return;const{type:e,data:i}=t.data;switch(e){case"moby:close":this.close();break;case"moby:resize":this.iframe&&i.height&&(this.iframe.style.height=`${i.height}px`);break;case"moby:track":this.trackEvent(i.event,i.properties);break;case"moby:lead-captured":this.handleLeadCaptured(i)}})),this.iframe&&this.iframe.addEventListener("load",(()=>{this.messageQueue.forEach((t=>this.sendMessage(t))),this.messageQueue=[]}))}open(){this.isOpen||(this.isOpen=!0,this.bubble.style.display="none",this.iframe&&(this.iframe.style.visibility="visible",this.iframe.style.opacity="1",this.iframe.style.transform="scale(1) translateY(0)"),this.trackEvent("chat_opened"),this.postMessage({type:"moby:opened"}))}close(){this.isOpen&&(this.isOpen=!1,this.iframe&&(this.iframe.style.opacity="0",this.iframe.style.transform="scale(0.95) translateY(20px)",setTimeout((()=>{this.iframe&&(this.iframe.style.visibility="hidden"),this.bubble.style.display="flex"}),300)),this.postMessage({type:"moby:closed"}))}toggle(){this.isOpen?this.close():this.open()}sendMessage(t){this.iframe&&this.iframe.contentWindow?this.postMessage({type:"moby:send-message",message:t}):this.messageQueue.push(t)}postMessage(t){this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage(t,this.baseUrl)}trackEvent(t,e){this.config.trackEvents&&(fetch(`${this.baseUrl}/api/widget/analytics`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:this.config.accountId,event:t,properties:e,url:window.location.href,referrer:document.referrer})}).catch((()=>{})),this.config.googleAnalyticsId&&"function"==typeof window.gtag&&window.gtag("event",t,{event_category:"MobyWidget",...e}))}handleLeadCaptured(t){this.trackEvent("lead_captured",t),window.dispatchEvent(new CustomEvent("moby:lead-captured",{detail:t}))}}!function(){const e=document.currentScript;if(!e)return void console.error("Moby Widget: Could not find script element");new t(e)}()}();